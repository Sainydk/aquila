Контроллер инструмента выполняет следующие функции:

1) Отслеживание и обновление атрибутов торговой сессии;
2) Создание экземпляра инструмента и установка его константных атрибутов;
3) Обработка тиковых данных;
4) Пересчет атрибутов открытых позиций;
5) Клиринг.

1) Отслеживание и обновление атрибутов торговой сессии.

К торговой сессии относятся такие атрибуты инструмента как размер и стоимость
тика, начальная маржа, верхний и нижний лимит цены, размер лота и т.п.
(полный список атрибутов см. в UML схеме). При отсутствии этих данных невозможно
выполнить расчет стоимости позиции, изменение маржи и т.п. Таким образом,
сессионные атрибуты инструмента являются основными для контроллера. По ходу
своей работы контроллер инструмента опирается именно на эти данные.

Параметры торговой сессии могут изменяться не только в начале или конце торговой
сессии, но и по ходу торговой сессии. Например, увеличение начальной маржи при
скачке волатильности, сдвиг границ ценового коридора в случае упора в планку и
т.п. Для того, что бы обеспечить возможность обновления этих атрибутов без
добавления в систему расписания, используется последовательность снимков
значений атрибутов торговой сессии. Для работы контроллеру необходим хотя бы
один снимок, чтобы установить начальные значения атрибутов. Если источник данных
вернет пустой итератор, то инструмент останется недоступным до конца работы
эмулятора. 

Каждый снимок атрибутов торговой сессии имеет привязку ко времени. Эта временная
метка указывает с какого времени начинают действовать соответствующие значения.
В начале работы контроллер делает запрос с целью получения итератора,
посредством которого он сможет перебирать снимки параметров в порядке
наступления изменений. Этот итератор используется на протяжении всего времени
работы контроллера. При запросе итератора котроллер использует текущее время
эмулятора, что бы первым в последовательности был снимок, актуальный на текущий
момент времени. Если такой снимок будет получен, то контроллер выполняет
первичную инициализацию непосредственно в момент получения итератора. 

Однако, не всегда возможно такое развитие ситуации. Нормальной ситуацией
является случай, когда на указанный момент времени в системе нет сессионных
данных. В таком случае источник возвращает выборку, которая начинается с
ближайшего к указанному времени снимку. Этот снимок датируется более поздним по
отношению к запрошенному временем (то есть ближайший в будущем, относительно
текущего времени эмулятора). В такой ситуации контроллер выполняет отложенную
инициализацию инструмента, регистрируя через планировщик эмулятора
соответствующую задачу.

2) Создание экземпляра инструмента и установка его константных атрибутов.

Некоторые атрибуты инструмента являются неизменными на протяжении всего времени
его существования. Помимо дескриптора инструмента, к таким данным относятся
полное наименование, время экспирации и т.п. (полный список атрибутов см. в UML
схеме). Эти атрибуты устанавливаются единожды в момент инстанцирования
экземпляра инструмента. Поскольку момент начала работы выбирается контроллером
на основании имеющихся данных о торговой сессии, этот этап является частью
первичной инициализации и выполняется в момент перед применением первого снимка
атрибутов торговой сессии. На данном этапе контроллер запрашивает эти атрибуты у
источника данных и выполняет установку соответствующих атрибутов инструмента,
после чего передает управление процедуре обновления атрибутов торговой сессии.

3) Обработка тиковых данных.

Подразумеваются тиковые, которые соответствуют совершающимся на рынке сделкам.
Каждый тик приводит к изменению оперативных атрибуты инструмента, таких как цена
открытия, максимальная и минимальная цены за сессию, цена последней сделки.
Каждый тик служит основанием для события о сделке по инструменту.

Обработка тиковых данных начинается в момент первичной инициализации. Сразу
после инстанцирования инструмента и установки сессионных атрибутов контроллер
инструмента создает и регистрирует в хронологии источник событий, обеспечивающий
обработку тиковых данных. 

4) Пересчет атрибутов открытых позиций;

Нужно понимать, что разные типы активов (или одни и те же активы, но на
разных площадках) могут учитываться по разному. Если принять во внимание наличие
такого артефакта как единый торговый счет, на котором одновременно могут
учитываться инструменты разных типов, становится понятно, что реализовать
алгоритм пересчета позиций в рамках портфеля нельзя и этот механизм должен
относиться к контроллеру инструмента. Однако, инициатором процедуры пересчета
должен выступать контроллер портфеля. Это связано с необходимостью обеспечить
согласованность между всеми позициями и атрибутами портфеля. Хотя в реальной
торговле на аналогичную согласованность расчитывать не приходится, в случае
эмулятора она нужна, так как значительно облегчает реализацию клиринговых
процедур.

Отдельно отметим такой атрибут позиции как вариационная маржа. Этот атрибут
имеет значение только для маржируемых инструментов. Например, для акций или
облигаций значение этого атрибута всегда равно нулю. При реализации позиции PL
не обязательно учитывается в атрибуте вариационной маржи. В зависимости от
специфики (инструмента, площадки, брокера, и т.п.), PL может быть сразу учтен в
балансе портфеля в момент ликвидации позиции. 

Следует также заметить, что атрибуты позиции, значение которых зависит от
рыночной цены в моменте, носят исключительно информационный характер (что
соответствует поведению известных нам реальных торговых систем). Это относится к
вариацоннной марже и рыночной стоимости открытой позиции. Точное значение
накопленной вариационной маржи становится известно только после ликвидации
позиции (для маржируемых инструментов). Это значение сохраняется до клиринга,
после чего переносится на баланс портфеля. Точная рыночная цена позиции может
быть получена только в период между торгами, то есть после клиринга но до начала
торговой сессии, когда можно гарантировать, что цена остается неизменной. 
 
Периодичность пересчета атрибутов открытых позиций определяется контроллером
портфеля. Например, это может быть пересчет с фиксированной периодичностью
и только при наличии открытых позиций. Это подразумевает, что отслеживание
позиций начинается в момент открытия позиции и прекращается при закрытии
последней открытой позиции. Такой мониторинг работает для всех портфелей (то
есть, появление новых портфелей постоянно отслеживается эмулятором).

После пересчета всех открытых позиций по портфелю, контроллер портфеля выполняет
актуализацию атрибутов подконтрольного портфеля. Собственно, актуализируется
только значение вариационной маржи и текущего баланса портфеля. Остальные
атрибуты контролируются при выполнении торговых операций. 

5) Клиринг.

Алгоритм клиринга может различается в зависимости от типа инструмента и может
зависить от данных, задействованных в механизме учета открытых позиций. В связи
с этим, процедура клиринга реализуется в рамках контроллера инструмента. Однако,
так как клиринг выполняется по всему портфелю, инициатором клиринга является
контроллер портфеля. Контроллер инструмента только информирует контроллер
портфеля о времени, на которое запланирован следующий клиринг по позиции.

Типичная процедура клиринга для срочных контрактов состоит из следующих этапов.
Прежде всего, выполняется пересчет атрибутов открытых позиций в соответствии с
текущими значениями атрибутов торговой сессии. В момент клиринга никакие сделки
не совершаются (как минимум потому, что с точки зрения эмулятора это
моментальная процедура) и по этому, после пересчета открытых позиций получаем
актуальные значения вариационной маржи. Эта вариационка зачитывается на счет
портфеля и обнуляется в соответствующем атрибуте портфеля.

После этого выполняется обновление атрибутов торговой сессии. Для фьючерсной
позиции здесь важен только размер гарантийного обеспечения. Новое значение ГО
используется для рассчета разницы ГО по отношению к предыдущей сессии, которая
зачитывается в счет портфеля. Таким образом, все открытые позиции становятся
подготовленными для дальнейшей работы.

Здесь возможна ситуация, когда итератор параметров торговой сессии не содержит
снимка, датированного после клиринга. Это не создает никаких проблем, так как
в этом случае пропускается только этап перерасчета ГО. При этом, открытые
позиции остаются с прежним ГО.

В завершении клиринга контроллер портфеля выполняет перерасчет своих собственных
атрибутов.  
