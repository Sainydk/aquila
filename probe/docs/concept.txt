Содержание

0) Обзор
1) Отслеживание и обновление атрибутов торговой сессии;
2) Создание экземпляра инструмента и установка его константных атрибутов;
3) Обработка тиковых данных;
4) Трекинг открытых позиций;
5) Клиринг.


0) Обзор

Probe - это программная реализация терминала, предназначенная для проведения
различных экспериментов, тестирования и отлаживания торговых стратегий.
Probe предоставляет тот же самый набор сервисов, что и другой терминал, имеющий
подключение к реальной торговой системе. Кроме того, Probe позволяет управлять
процессом симуляции торгов: запускать и останавливать, выполнять торги в
пошаговом режиме и режиме реального времени.

В основе функционирования терминала лежит принцип воспроизведения
последовательности событий, которые положены на общую временную шкалу - шкалу
воспроизведения. Ключевой функционал скрыть в реализации планировщика событий,
который имеет интерфейс, определяемой стандартной моделью терминала. С точки
зрения реализации, нет никакой разницы между системными событиями, такими как
воспроизведение сделки по инструменту или клиринг, и пользовательскими
событиями, регистрируемыми через интерфейс планировщика. Для эмулятора все
события равноценны и Probe воспроизводит их в очередности, которая определена
временными метками этих событий. Таким образом, что бы выполнить эмуляцию
какой-либо деятельности, необходимо обеспечить наличие на шкале времени
соответствующих событий. В случает отсутствия событий запуск эмулятора будет
завершен без выполнения какой-либо полезной работы. 

Изначально шкала воспроизведения не содержит событий. Что бы запустить процесс у
терминала должен быть хотя бы один потребитель, который в момент запуска
эмуляции в обработчике стандартных (для модели терминала) событий запуска или
подключения терминала выполнит действия, которые приведут к появлению каких-либо
событий на шкале эмулятора.
 
Типичный пример - это подписка на инструменты. При запросе инструмента с помощью
соответствующего метода терминала, которые как правило выполняются в обработчике
OnConnected терминала, Probe запускает контроллер инструмента, который будет
отвечать за присутствие инструмента в системе. Естественно, что это возможно
только в том случае, если в базе данных есть соответствующие данные. В процессе
работы, контроллер воспроизводит поведение инструмента, включая генерацию
сделок, изменение атрибутов и клиринговые процедуры в соответствии с имеющейся в
базе данных информацией. При этом, потребитель может использовать стандартную
модель терминала для работы с инструментами и совершению операций идентично
тому, как это делается при работе с терминалом, имеющим реальное подключение к
торговой системе. Такой подход позволяет не только тестировать стратегии,
которые основанны на анализе непрерывной последовательности свечей, но и
отрабатывать вообще любые процессы, типичные для торговых систем в том числе и
комплексное планирование задач.  


1) Отслеживание и обновление атрибутов торговой сессии.

К торговой сессии относятся такие атрибуты инструмента как размер и стоимость
тика, начальная маржа, верхний и нижний лимит цены, размер лота и т.д. При
отсутствии этих данных невозможно выполнить расчет стоимости позиции, изменение
маржи и т.п. Таким образом, наличие данных торговой сессии для инструмента
являются важным условием для процесса эмуляции. 

Параметры торговой сессии могут изменяться не только в начале или конце торговой
сессии, но и по ходу торговой сессии. Например, увеличение начальной маржи при
скачке волатильности, сдвиг границ ценового коридора в случае упора в планку и
т.п. Для того, что бы обеспечить возможность обновления этих атрибутов без
добавления в систему сложного механизма расписания работы, используется
последовательность снимков значений атрибутов торговой сессии. Для работы
контроллеру необходим хотя бы один снимок, чтобы установить начальные значения
атрибутов. Если источник данных вернет пустой итератор, то инструмент будет
оставаться недоступным до конца работы эмулятора. 

Каждый снимок атрибутов торговой сессии имеет привязку ко времени. Эта временная
метка указывает начиная с какого времени действует соответствующие значения.
В начале работы контроллер запрашивает хранилище данных с целью получения
итератора снимков, посредством которого он сможет перебирать данные в порядке
наступления данных. Этот итератор используется на протяжении всего времени
работы контроллера. При запросе итератора котроллер использует текущее
время эмулятора, что бы первым в последовательности был снимок, актуальный на
текущий момент времени.

Если первый снимок последовательности соответствует времени терминала или более
раннему времени, то первичная инициализация инструмента планируется на ближайшее
возможное время. Однако, нормальной ситуацией является и отсутствие сессионных
данных на текущий момент времени. В этом случае итератор начинается с ближайшего
после указанного времени снимка, а контроллер выполняет отложенную инициализацию
инструмента в соответствии со временем первого снимка в последовательности.

2) Создание экземпляра инструмента и установка его константных атрибутов.

Некоторые атрибуты инструмента являются неизменными на протяжении всего времени
его существования. Помимо дескриптора инструмента, к таким данным относятся
полное наименование, время экспирации и т.п. (полный список атрибутов см. в UML
схеме). Эти атрибуты устанавливаются единожды в момент инстанцирования
экземпляра инструмента. Поскольку момент начала работы выбирается контроллером
на основании имеющихся данных о торговой сессии, этот этап является частью
первичной инициализации и выполняется в момент перед применением первого снимка
атрибутов торговой сессии. На данном этапе контроллер запрашивает эти атрибуты у
источника данных и выполняет установку соответствующих атрибутов инструмента,
после чего передает управление процедуре обновления атрибутов торговой сессии.

3) Обработка тиковых данных.

Тиковые данные соответствуют совершенным на рынке сделкам. Каждый тик приводит к
изменению оперативных атрибуты инструмента, таких как цена открытия,
максимальная и минимальная цены за сессию, цена последней сделки. Каждый тик
служит основанием для события о сделке по инструменту.

Обработка тиковых данных начинается в момент первичной инициализации. Сразу
после инстанцирования инструмента и установки сессионных атрибутов контроллер
инструмента создает и регистрирует в хронологии источник событий, обеспечивающий
обработку тиковых данных. 

4) Трекинг открытых позиций.

Для работы с позициями необходимо наличие портфелей. Эмулятор торгового
терминала позволяет создавать произвольное количество тестовых портфелей. Для
работы тестовых портфелей требуется корректное обновление атрибутов инструмента
и поток сделок по нему. Каждый портфель предоставляет расширенный публичный
интерфейс для управления счетом и позициями. С помощью этого интерфейса на
баланс счета можно зачислять и списывать средства, а так же увеличивать и
сокращать позиции.

После того, как в тестовом портфеле образуется ненулевая позиция, начинается ее
отслеживание с целью актуализации атрибутов позиции и портфеля. Пересчет
атрибутов выполняется не с каждым тиком, а с определенным настраиваемым
интервалом, как это обычно бывает в реальных торговых терминалах. Таким образом,
атрибуты позиции, значение которых зависит от рыночной цены в моменте, носят
исключительно информационный характер. Это относится к таким атрибутам как
вариацонная маржа и рыночная стоимость открытой позиции. Точные значения, как и
в реальных системах, становятся известными только после ликвидации позиции.

Следует заметить, что в рамках тестового портфеля не выполняется никакой
риск-менеджмент. Портфель или позиция может уйти в минус и это не вызовет
никакой реакции со стороны эмулятора. Стратегия риск-менеджмента должна
реализовываться отдельным сервисом, который может использовать публичный
интерфейс тестового портфеля для целей управления. Например, для принудительного
закрытия позиций.

Механизм эмуляции портфелей использует только штатные средства терминала для
доступа к атрибутам инструмента и тиковым данным. 


5) Клиринг.

TODO: 

Алгоритм клиринга может различается в зависимости от типа инструмента и может
зависить от данных, задействованных в механизме учета открытых позиций. В связи
с этим, процедура клиринга реализуется в рамках контроллера инструмента. Однако,
так как клиринг выполняется по всему портфелю, инициатором клиринга является
контроллер портфеля. Контроллер инструмента только информирует контроллер
портфеля о времени, на которое запланирован следующий клиринг по позиции.

Типичная процедура клиринга для срочных контрактов состоит из следующих этапов.
Прежде всего, выполняется пересчет атрибутов открытых позиций в соответствии с
текущими значениями атрибутов торговой сессии. В момент клиринга никакие сделки
не совершаются (как минимум потому, что с точки зрения эмулятора это
моментальная процедура) и по этому, после пересчета открытых позиций получаем
актуальные значения вариационной маржи. Эта вариационка зачитывается на счет
портфеля и обнуляется в соответствующем атрибуте портфеля.

После этого выполняется обновление атрибутов торговой сессии. Для фьючерсной
позиции здесь важен только размер гарантийного обеспечения. Новое значение ГО
используется для рассчета разницы ГО по отношению к предыдущей сессии, которая
зачитывается в счет портфеля. Таким образом, все открытые позиции становятся
подготовленными для дальнейшей работы.

Здесь возможна ситуация, когда итератор параметров торговой сессии не содержит
снимка, датированного после клиринга. Это не создает никаких проблем, так как
в этом случае пропускается только этап перерасчета ГО. При этом, открытые
позиции остаются с прежним ГО.

В завершении клиринга контроллер портфеля выполняет перерасчет своих собственных
атрибутов.  
