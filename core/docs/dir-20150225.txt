Директива 20150225
[[[[ О стандартизации механизмов синхронных и асинхронных событий ]]]]

Основание

После реализации директивы 20141205 (О введении синхронных событий терминала)
было выявлено, что решение возникших проблем путем введения интерфейсов
синхронных обработчиков оказывает негативное влияние на дизайн системы.
Количество кейсов, когда нужно получить синхронную реакцию на событие, растет.
При этом растет количество изменений, в связи с реализацией синхронных
взаимодействий. При этом замечено, что текущий интерфейс событийной подсистемы
полностью удовлетворяет и поставщиков и потребителей.

Выявлено множество пограничных ситуаций, когда отношение к типу события
(синхронное или асинхронное) имеет разную значимость для участников процесса.
В некоторых случаях, поставщик хочет получить некую реакцию непосредственно
после рассылки событий (как в ситуации-основании директивы 20141205). С другой
стороны, многие алгоритмы могут быть легко реализованы, если потребитель имеет
возможность реагировать на событие непосредственно в момент его возникновения.
Сейчас в таких случаях иногда используется впрыск поставщику синхронной очереди,
но это так или иначе диктует дизайн поставщика и плохо влияет на дизайн. 

Конечно, в большинстве случаев поставщикам все равно, когда и кем будет
обработано событие. Так же как и большинству потребителей все равно когда было
отправлено событие. Но в некоторых случаях наличие возможности жестко определять
тип события при его создании для поставщика или подписываться на получение
события в синхронном режиме для потребителя значительно облегчает дело.
Сейчас подобной возможности нет.


--------------------------------------------------------------------------------

Подход 

В целях унификации работы с синхронными и асинхронными событиями предлагается
дополнить интерфейс событийной подсистемы возможностью указывать спецификации
доступных способов рассылки и способов их получения. Обеспечить возможность
работы с любым способом доставки в рамках единой реализации. 


--------------------------------------------------------------------------------

Порядок редизайна

Наивысший приоритет при выборе доступных типов оповещений определяет владелец.
Происходит это в момент создания нового типа события. Если владелец требует,
чтобы все события данного типа отправлялись в синхронном режиме, то все
подписчики будут уведомляться в синхронном режиме, независимо от того, какой
способ доставки они предпочитают. Текущие фабричные методы по-умолчанию
инстанцируют тип события, допускающий любой желаемый подписчиком способ
доставки. Для создания типа события с ограничением по способу доставки только
синхронным способом владелец должен использовать специальный фабричный метод.

Нынешняя реализация метода подписки на тип события по-умолчанию определяет
подписчика в пул асинхронных получателей событий. Независимо от своего выбора,
подписчик попадает в пул синхронных получателей, если тип события был создан
с ограничением асинхронной подачи событий. Подписчик должен использовать
специальный метод подписки для получения событий в синхронном режиме.   

Основная сложность заключается в корректной организации трансляции событий
смешанным способом. Механизмы асинхронной и синхронной трансляции событий уже
отработаны и представлены отдельными реализациями очередей. Следует объединить
эти реализации в одну, после чего синхронную реализацию можно удалить как
более простую и редко используемую.

Вопрос, который требует детальной проработки это порядок трансляции событий.
Трансляция должна выполняться в два этапа. Сначала выполняется трансляция
для синхронных подписчиков. В результате работы подписчиков этой категории в
очередь могут попадать новые события для трансляции. Эти события помещаются в
первую очередь обработки. Трансляция для синхронных подписчиков продолжается до
тех пор, пока в первой очереди есть события. После обработки, события первой
очереди перемещаются во вторую очередь. Здесь можно столкнуться с бесконечной
рекурсией, если один из подписчиков косвено или прямо синхронно реагирует на
свое собственное событие. Но это не повод для особого беспокойства, так как
способов выстрелить себе в ногу существует предостаточно. После того, как первая
очередь опустела, выполняется асинхронная трансляция событий второй очереди.
Фактически, события второй очереди передаются на обработку потоку трансляции
асинхронных событий. 

Помимо вышеописанных ключевых изменений, необходимо выполнить улучшения дизайна
событийной системы. Прежде всего, типу события с целью сокрытия методов работы
со списками подписчиков необходимо добавить служебный интерфейс. С точки зрения
дизайна, рядовые подписчики не должны взаимодействовать с подобно информацией. 
Вместе с этим, необходимо удалить все deprecated методы из различных компонентов
событийной системы.
