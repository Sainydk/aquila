Выжные моменты, которые необходимо учитывать, во избежание неожиданных
результатов.

1. При разработке стратегий на базе событий нужно понимать, как работает
механизм трансляции событий. Следует уяснить, что события являются не связанными
между собой сущностями. Нужно четко осознавать, что события могут поступать
в любом (неопределенном) порядке. Некоторые события являются следствием
обработки других событий. В некоторых случаях может создаваться иллюзия
синхронности состояний связанных (зависимых) объектов, что может приводить
к неожиданным результатам.

Рассмотрим пример стратегии, которая принимает решения на основании обработки
статуса заявки и отчета по трейдам (report.ActiveTrades). Событие, которое
инициирует первое действите не рассматриваем, так как это не важно, а важно
рассмотреть состояние отчета и дальнейшую последовательность работы.

Итак, основанием для принятия решения служит поступление события об изменении
статуса заявки. При получении этого события программа выполняет выставление
заявок, в соответствии с информацией о текущем трейде: если текущий трейд
открыт, то выставляется заявка на закрытие позиции; если нет текущего трейда,
то выставляется вилка на открытие позиции.

На практике, такой алгоритм практически наверняка приведет к ошибочному
результату. Это связано с тем, что отчет по трейдам формируется на основании
событий о сделках. Но это события отличного от инициирующего процесс типа. И
возникновение событий о сделках происходит в иные моменты относительно момента
генерации события по заявке (на практике это связано с тем, что события о
сделках ретранслируются и таким образом помещаются в очередь после события
о смене статуса заявки). Таким образом, возникает ситуация несогласованности
отчета по трейдам в момент обработки изменения статуса заявки. Нет никакой
гарантии, что на момент получения события о статусе заявки, соответствующие
сделки уже обработаны отчетом по трейдам и он содержит актуальную информацию.

Выходом из данной ситуации является использование в качестве инициирующего
события отчета по трейдам. Поскольку решение принимается по состоянию отчета,
инициатором процесса должно выступать событие о смене состояние отчета.

Существует множество аналогичных ситуаций и все их рассмотреть практически
невозможно. Определять такие ситуации автоматически так же невозможно.
Использование синхронной событийном модели не решает проблему несогласованности,
так как последовательность действий сохраняется. Единственный вариант не попасть
в эту ловушку - всегда помнить, что разные события не связаны между собой и на
момент обработки одного события, связанный объект может быть еще не согласован.
При использовании анализа состояния нужно опираться на события от объекта,
представляющего это самое состояние или выполнять перерасчет состояния в момент
обработки инициирующего события.   