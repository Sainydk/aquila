package ru.prolib.aquila.stat.counter;

import static org.easymock.EasyMock.createStrictControl;
import static org.easymock.EasyMock.expectLastCall;
import static org.junit.Assert.assertNull;

import java.util.Date;
import java.util.Observer;

import org.easymock.IMocksControl;
import org.junit.Before;
import org.junit.Test;

import ru.prolib.aquila.ChaosTheory.ServiceLocator;
import ru.prolib.aquila.ChaosTheory.ServiceLocatorImpl;
import ru.prolib.aquila.stat.PositionChange;
import ru.prolib.aquila.stat.TrackingTrades;
import ru.prolib.aquila.stat.TradeEvent;
import ru.prolib.aquila.stat.TradeReport;
import ru.prolib.aquila.ta.TestValue;
import ru.prolib.aquila.ta.ds.MarketData;
import ru.prolib.aquila.ta.ds.MarketDataImpl;
import ru.prolib.aquila.ta.ds.MarketDataReaderFake;


public class LastTradeOpenTest {
	IMocksControl control;
	ServiceLocator locator;
	TrackingTrades tracking;
	MarketDataImpl data;
	Observer observer;
	LastTradeOpen value;
	
	@Before
	public void setUp() throws Exception {
		control = createStrictControl();
		locator = new ServiceLocatorImpl();
		tracking = control.createMock(TrackingTrades.class);
		observer = control.createMock(Observer.class);
		data = new MarketDataImpl(new MarketDataReaderFake(1));
		locator.setTrackingTrades(tracking);
		locator.setMarketData(data);
		value = new LastTradeOpen();
	}
	
	@Test
	public void testStartService_Ok() throws Exception {
		tracking.addObserver(value);
		control.replay();
		
		value.startService(locator);
		
		control.verify();
	}
	
	@Test (expected=CounterServiceAlreadyStartedException.class)
	public void testStartService_ThrowsIfStarted() throws Exception {
		tracking.addObserver(value);
		control.replay();
		
		value.startService(locator);
		
		control.verify();
		value.startService(locator);
	}
	
	@Test
	public void testStopService_OkNotStarted() throws Exception {
		control.replay();
		
		value.stopService();
		
		control.verify();
	}
	
	@Test
	public void testStopService_OkStarted() throws Exception {
		tracking.addObserver(value);
		tracking.deleteObserver(value);
		control.replay();
		
		value.startService(locator);
		value.stopService();
		value.stopService();
		
		control.verify();
	}
	
	@Test
	public void testGetValue_NullBeforeUpdate() throws Exception {
		assertNull(value.getValue());
	}
	
	@Test
	public void testUpdate_IgnoreIfNotNewTrade() throws Exception {
		control.replay();
		
		value.update(data, this);
		
		control.verify();
	}
	
	@Test
	public void testUpdate_Ok() throws Exception {
		Date first = new Date();
		TestValue<Date> time = new TestValue<Date>(MarketData.TIME, first);
		data.addValue(time);
		TradeReport trade = new TradeReport();
		trade.addChange(new PositionChange(0, 1, 15d));
		trade.addChange(new PositionChange(-1, 1, 15d));
		
		tracking.addObserver(value); // from startService
		observer.update(value, null);
		expectLastCall().andDelegateTo(new TestCounterValue<Date>(first));
		control.replay();
		
		value.addObserver(observer);
		value.startService(locator);
		value.update(null, TradeEvent.newTrade(trade));
		
		control.verify();
	}

}
